extends layout

block meta
	meta(name="viewport", content="width=528, user-scalable=no")
	
block javascript
	// script(src="https://getfirebug.com/firebug-lite.js#enableTrace")
	
	link(href='http://fonts.googleapis.com/css?family=VT323', rel='stylesheet', type='text/css')
	link(href='http://fonts.googleapis.com/css?family=Anaheim', rel='stylesheet', type='text/css')
	style.
		@font-face {
			font-family: 'pixeladeregular';
			src: url('/fonts/pixelade-webfont.eot');
			src: url('/fonts/pixelade-webfont.eot?#iefix') format('embedded-opentype'),
				url('/fonts/pixelade-webfont.woff') format('woff'),
				url('/fonts/pixelade-webfont.ttf') format('truetype'),
				url('/fonts/pixelade-webfont.svg#pixeladeregular') format('svg');
			font-weight: normal;
			font-style: normal;
		}

	
	link(href='/stylesheets/game#{gameScale}.css', rel='stylesheet')

	script(src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js")
	script(src="http://cdn.sockjs.org/sockjs-0.3.min.js")
	script(src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.2.1/lodash.js")
	
	script(src="http://code.createjs.com/createjs-2013.12.12.min.js")
	
	script(src="../client/Loader.js")
	script(src="../client/ColorSubstitutionFilter.js")
	script(src="../client/ColorMatrix.js")
	script(src="../client/ColorMatrixFilter.js")
	script(src="../client/tweakDOMElement.js")
	script(src="../client/config.js")
	// addons.js may change to be generated by server rather than a static file:
	script(src="../client/addons.js")
	script(src="../client/Avatar.js")
	script(src="../client/AvatarAssets.js")
	script(src="../client/AddonsList.js")
	script(src="../client/DressingRoom.js")
	script(src="../client/Homeroom.js")
	script(src="../client/HomeroomGameListing.js")
	script(src="../client/GameRoom.js")
	script(src="../client/GameRoomPlayer.js")
	script(src="../client/GameRoomConsole.js")
	script(src="../client/GameActionMenu.js")
	script(src="../client/GameRoomResultsDisplay.js")
	script(src="../client/Sound.js")
	script(src="../client/Comm.js")
	script(src="../client/Main.js")
	
	script(type='text/javascript').
		var token = '#{token}';
		var session = '#{session}';
		var school = '#{school}';
		
		// big global variable for remembering stuff 
		var g = {load:{}, dressing:{}, homeroom:{}, game:{}};
		
		g.gameScale = '#{gameScale}';
		
		// sissyfight namespace
		this.sf = this.sf||{};
				

		sf.start = function(SockJS, auth, school) {
			
			var appCanvas, appCanvasID = 'appCanvas';

			appCanvas = document.getElementById(appCanvasID); 
			
			// more ways to prevent antialiased scaling, via http://stackoverflow.com/a/17761798
			var context = appCanvas.getContext('2d');
			context.webkitImageSmoothingEnabled = context.imageSmoothingEnabled = context.mozImageSmoothingEnabled = context.oImageSmoothingEnabled = false;
		
			// disable browser drag-and-drop on game canvas 
			//		http://developer.nokia.com/Community/Wiki/How_to_disable_dragging_of_images_and_text_selection_in_web_pages
			//		http://stackoverflow.com/questions/704564/disable-drag-and-drop-on-html-elements
			appCanvas.draggable = false;
			appCanvas.onmousedown = function(event) {
				if (event.preventDefault) event.preventDefault();
				return false;
			}
			

			var stage = new createjs.Stage(appCanvasID);
			createjs.Touch.enable(stage);
			var main = new sf.Main();
			main.scaleX = main.scaleY = g.gameScale;
			stage.addChild(main);
			main.start(SockJS, auth, school);
		}
		
		// prevent accidentally leaving game by hitting backspace
		// http://stackoverflow.com/a/19394745
		$(document).on("keydown", function (e) {
			if (e.which === 8 && !$(e.target).is("input[type='text']:not([readonly]), textarea")) {
				e.preventDefault();
			}
		});


		
block content
	//-.
		table
			tr
				td: form(method='post',action='/user/logout')
						input(type='submit', value='log out')
				td: form(method='get',action='/game')
						input(type='submit', value='reload')
						if (gameScale==2)
							input(type='hidden', name='double', value='1')
				td	
					a(HREF="https://docs.google.com/forms/d/1lLWMiJlPY2hu5SJhrNUeacD--9F_wtsIEHiddGl18UQ/viewform", target='_blank')
						please click here to fill out a bug report
						
			
	script(type='text/javascript').
		window.onload = function() {
			sf.start(SockJS, {token:token, session:session, endpoint:'/sox'}, school);
		}
		
			
		
	style.
		/*	attempt to scale up canvas while preserving pixels - 
			fails to prevent blurring on firefox and chrome, but works on safari and ios 5 and 6 browser 
			https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering
		*/
		
		.pixelated {   
			image-rendering:-webkit-optimize-contrast; 
			image-rendering:pixelated;  
			image-rendering:moz-crisp-edges; 
			image-rendering:-o-crisp-edges;    
			-ms-interpolation-mode: nearest-neighbor;
			
			image-rendering:optimizeSpeed;              /* Legal fallback                 */
			image-rendering:-moz-crisp-edges;           /* Firefox                        */
			image-rendering:crisp-edges;                /* CSS3 Proposed                  */
			
			// turn off font-smoothing
			// will need to experiment with fonts and sizes to get away with unsmoothed fonts
			// http://stackoverflow.com/a/10538659 : 
			// font-smooth: never;
			// -webkit-font-smoothing : none;
			}

		.hidden {
			visibility: hidden;
		}

		#container {
			position: relative;
			/* font for html-based text (chat and polaroid captions) */ 
			font-family: 'pixeladeregular';
		}
		#container input {
			font-family: 'pixeladeregular';
			resize: none;
		}
		#container textarea {
			font-family: 'pixeladeregular';
			resize: none;
			margin: 0;
			padding: 0;
			border: 0;
			overflow: hidden;
		}
		
		.disableSelect {
			-webkit-user-select: none;  
			-moz-user-select: none;    
			-ms-user-select: none;      
			user-select: none;
		}

		.fixedText {
			resize: none;
			overflow: hidden;
			border: none;
		}
		
		
	div.gameSize#container(width='#{gameWidth}', height='#{gameHeight}')
		canvas.gameSize.pixelated#appCanvas(width='#{gameWidth}', height='#{gameHeight}')
		
		div.homeroomText.disableSelect.wordwrap.fixedText.hidden#homeroomChat(unselectable="yes")
		textarea.homeroomText.hidden#homeroomTextEntry
		
		textarea.gameroomText.gameroomChatNormal.hidden#gameroomTextEntry
		each i in [0,1,2,3,4,5]
			div.gameroomText.gameroomPlayerChatBubble.gameroomChatNormal.disableSelect.wordwrap.fixedText.hidden(id='gameroomChatBubble'+i)
			
		div.captionText.disableSelect.wordwrap.hidden#gameroomCaption(unselectable="yes")
		
		input.homeroomText.hidden#homeroomCreateGameEntry(type='text', maxlength=12)
		
		
		
		
	